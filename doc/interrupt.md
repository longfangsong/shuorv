# 中断处理

在本CPU的中断处理中，硬件负责的部分的工作是：

- 判断是否有中断需要处理
  这是由几个 CSR 寄存器负责的：
  
  - `mstatus` 的 `MIE` 字段
  
     这个字段控制所有中断的开启和关闭。
     
  - `mie`
  
     这个寄存器的各个字段控制各种不同种类的中断的开启和关闭。
  
  - `mip`
  
     这个寄存器的某个字段如果被置位，对应种类的中断正在等待被处理。
  
     一般由外部中断源负责置位。
  
  在每次执行指令前，会检查
  
  ```scala
   mstatus(MIRField.MIE) & (mie & mip).orR()
  ```
  
  来判断是否有要处理的中断。
  
- 跳转到中断处理位置，并保存跳转回来的时候要跳到哪去

  每个时钟周期都会用上述方法检查是否有中断需要处理，如果有，会要求 CSR 翻转`mstatus` 的 `MIE` 字段，并设置 CSR 中的`mepc`为下一条指令的`pc`，而把 `pc` 设置为当前 `mip` 中的中断类型对应的地址（根据 `mtvec` csr 计算，详见手册）。

- 中断内部内容，如现场保存，由软件负责

- 执行 `mret` 指令时

  同样要求 CSR 翻转`mstatus` 的 `MIE` 字段，并把 `pc` 设置为 `mepc` 的值。

